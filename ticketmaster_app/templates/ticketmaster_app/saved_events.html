{% extends 'ticketmaster_app/base.html' %}
{% load static %}

{% block title %}Saved Events{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Your Saved Events</h2>

  {% if saved_events %}
    <p class="text-muted">{{ saved_events.count }} saved event{{ saved_events.count|pluralize }}</p>

    {% for event in saved_events %}
      <div class="card mb-3">
        <div class="row g-0">
          <div class="col-md-3">
            {% if event.event_image_url %}
              <img src="{{ event.event_image_url }}" class="event-image rounded-start" alt="{{ event.event_name }}">
            {% else %}
              <img src="https://via.placeholder.com/300x200?text=No+Image" class="event-image rounded-start" alt="No image">
            {% endif %}
          </div>
          <div class="col-md-9">
            <div class="card-body">
              <h5 class="card-title">{{ event.event_name }}</h5>
              <p class="card-text">
                <i class="bi bi-geo-alt-fill"></i> {{ event.venue_name|default:"Venue TBA" }}<br>
                <small class="text-muted">
                  {% if event.venue_city and event.venue_state %}
                    {{ event.venue_city }}, {{ event.venue_state }}
                  {% endif %}
                </small>
              </p>
              <p class="card-text">
                <strong>Date:</strong> {{ event.event_date|default:"TBA" }}<br>
                <strong>Time:</strong> {{ event.event_time|default:"TBA" }}<br>
                <small class="text-muted">Saved: {{ event.saved_at|date:"M d, Y" }}</small>
              </p>

              {% if event.notes %}
                <p class="card-text">
                  <strong>Notes:</strong> {{ event.notes }}
                </p>
              {% endif %}

              <a href="{{ event.event_url }}" target="_blank" class="btn btn-primary btn-sm">
                <i class="bi bi-ticket-perforated"></i> Get Tickets
              </a>

              <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal{{ event.event_id }}">
                <i class="bi bi-pencil"></i> Edit Notes
              </button>

              <form method="POST" action="{% url 'delete_saved_event' event.event_id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this event?');">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Modal -->
      <div class="modal fade" id="editModal{{ event.event_id }}" tabindex="-1" aria-labelledby="editModalLabel{{ event.event_id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel{{ event.event_id }}">Edit Notes for {{ event.event_name }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'edit_saved_event' event.event_id %}">
              {% csrf_token %}
              <div class="modal-body">
                <div class="mb-3">
                  <label for="notes{{ event.event_id }}" class="form-label">Add your notes about this event:</label>
                  <textarea name="notes" id="notes{{ event.event_id }}" class="form-control" rows="4" placeholder="e.g., Going with friends, front row seats, birthday surprise...">{{ event.notes }}</textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    {% endfor %}

  {% else %}
    <div class="alert alert-info">
      No saved events yet. <a href="{% url 'index' %}">Search for events</a> to save some.
    </div>
  {% endif %}
</div>
{% endblock %}