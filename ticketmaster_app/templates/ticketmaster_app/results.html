{% extends 'ticketmaster_app/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Search Results{% endblock %}

{% block extra_css %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="top-section">
  <div class="container">
    <h2 class="text-center mb-3">Search Results</h2>
    <div class="row justify-content-center">
      <div class="col-md-8">
        <form method="POST" action="{% url 'search_events' %}">
          {% csrf_token %}
          {{ form|crispy }}
          <button type="submit" class="btn btn-primary w-100">SEARCH</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  {% if events %}
    <div class="mb-3"><h5>{{ results_count }} event{{ results_count|pluralize }} found</h5></div>

    {% for event in events %}
      <div class="card mb-3" id="event-{{ event.id }}">
        <div class="row g-0">
          <div class="col-md-3">
            {% if event.image_url %}
              <img src="{{ event.image_url }}" class="event-image rounded-start" alt="{{ event.name }}">
            {% else %}
              <img src="https://via.placeholder.com/300x200?text=No+Image" class="event-image rounded-start" alt="No image">
            {% endif %}
          </div>
          <div class="col-md-9">
            <div class="card-body">
              <h5 class="card-title">{{ event.name }}</h5>

              <p class="card-text">
                <i class="bi bi-geo-alt-fill"></i> {{ event.venue_name }}
                {% if event.venue_city %}
                  <br><small class="text-muted">
                    {{ event.venue_city }}{% if event.venue_state %}, {{ event.venue_state }}{% endif %}
                  </small>
                {% endif %}
              </p>

              <p class="card-text">
                <strong>Date:</strong> {{ event.event_date }}<br>
                <strong>Time:</strong> {{ event.event_time }}
              </p>

              <a href="{{ event.url }}" target="_blank" class="btn btn-primary btn-sm">
                <i class="bi bi-ticket-perforated"></i> Get Tickets
              </a>

              {% if user.is_authenticated %}
                {% if event.is_saved %}
                  <button class="btn btn-secondary btn-sm" disabled>
                    <i class="bi bi-bookmark-fill"></i> Saved
                  </button>
                {% else %}
                  <button type="button" class="btn btn-success btn-sm"
                    onclick="saveEvent(
                      '{{ event.id }}',
                      '{{ event.name|escapejs }}',
                      '{{ event.url|escapejs }}',
                      '{{ event.image_url|escapejs }}',
                      '{{ event.venue_name|escapejs }}',
                      '{{ event.venue_address|escapejs }}',
                      '{{ event.venue_city|escapejs }}',
                      '{{ event.venue_state|escapejs }}',
                      '{{ event.event_date|escapejs }}',
                      '{{ event.event_time|escapejs }}'
                    )">
                    <i class="bi bi-bookmark-plus" id="icon-{{ event.id }}"></i>
                    <span id="text-{{ event.id }}">Save</span>
                  </button>
                {% endif %}
              {% else %}
                <a href="{% url 'login' %}" class="btn btn-outline-success btn-sm">
                  <i class="bi bi-box-arrow-in-right"></i> Login to Save
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}

  {% else %}
    <div class="alert alert-info">No results found for "{{ classification }}" in {{ city }}.</div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function saveEvent(eventId, eventName, eventUrl, eventImageUrl, venueName, venueAddress, venueCity, venueState, eventDate, eventTime) {
  $.ajax({
    url: '{% url "save_event_ajax" %}',
    type: 'POST',
    data: {
      'event_id': eventId,
      'event_name': eventName,
      'event_url': eventUrl,
      'event_image_url': eventImageUrl,
      'venue_name': venueName,
      'venue_address': venueAddress,
      'venue_city': venueCity,
      'venue_state': venueState,
      'event_date': eventDate,
      'event_time': eventTime,
      'csrfmiddlewaretoken': '{{ csrf_token }}'
    },
    success: function(response) {
      if (response.saved || response.already_saved) {
        $('#icon-' + eventId).removeClass('bi-bookmark-plus').addClass('bi-bookmark-fill');
        $('#text-' + eventId).text('Saved');
        $('#text-' + eventId).parent().removeClass('btn-success').addClass('btn-secondary').prop('disabled', true).attr('onclick', '');
      } else {
        alert('Error: ' + response.message);
      }
    },
    error: function(xhr, status, error) {
      if (xhr.status === 403 || xhr.status === 302) {
        window.location.href = '{% url "login" %}';
      } else {
        alert('Error saving event. Please try again.');
      }
    }
  });
}
</script>
{% endblock %}